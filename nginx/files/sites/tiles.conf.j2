proxy_cache_path /var/www/tilecache/new levels=1:2 inactive=3d keys_zone=new_tilecache:64m max_size=4096M;

server {
    listen 80;
    listen [::]:80;

    server_name {{ hostnames }};

    include "snippets/acme-challenge.conf";

    access_log "/var/log/nginx/{{ site_name }}/access.log";
    error_log "/var/log/nginx/{{ site_name }}/error.log";

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # server_name {{ hostnames }};
    server_name ~^(?<site_id>[0-9]+).tiles.ffka.tech$;

    ssl_certificate "/etc/letsencrypt/live/{{ certificate_filename }}/fullchain.pem";
    ssl_certificate_key "/etc/letsencrypt/live/{{ certificate_filename }}/privkey.pem";

    include "snippets/acme-challenge.conf";
    include "snippets/tls.conf";

    access_log "/var/log/nginx/{{ site_name }}/access.log";
    error_log "/var/log/nginx/{{ site_name }}/error.log";

    location ~ ^/tiles/(?<provider>(giscience|ffrgb-day|ffrgb-night)+)/(?<tile_z>[0-9]+)/(?<tile_x>[0-9]+)/(?<tile_y>[0-9]+)/((?<retina>(.+))/)? {

        resolver 1.1.1.1 ipv6=off;
        if ($provider = "giscience") {
            proxy_pass "http://korona.geog.uni-heidelberg.de/tiles/roads/x=$tile_x&y=$tile_y&z=$tile_z";
        }
        if ($provider = "ffrgb-day") {
            proxy_pass "https://1.tiles.ffrgb.net/$tile_z/$tile_x/$tile_y$retina.png";
        }
        if ($provider = "ffrgb-night") {
            proxy_pass "https://2.tiles.ffrgb.net/n/$tile_z/$tile_x/$tile_y$retina.png";
        }

        proxy_http_version    1.1;
        proxy_set_header    Connection "";
        proxy_set_header    Accept-Encoding "";
        proxy_set_header    User-Agent "Mozilla/5.0 (compatible; OSMTileCache/1.0; +mailto:info@karlsruhe.freifunk.net; +https://karlsruhe.freifunk.net/karte)";

        proxy_temp_path     /var/www/tilecache/temp;
        proxy_cache         new_tilecache;
        proxy_store         off;
        proxy_cache_key     $uri$is_args$args;
        proxy_ignore_headers Expires Cache-Control;
        proxy_cache_valid   200 301 302 7d;
        proxy_cache_valid   404 1m;
        proxy_cache_valid   any 1m;
        proxy_next_upstream   error timeout invalid_header http_500 http_502 http_503 http_504 http_403 http_404;
        proxy_cache_use_stale error timeout updating invalid_header http_500 http_502 http_503 http_504 http_403 http_404;

        proxy_hide_header   Via;
        proxy_hide_header   X-Cache;
        proxy_hide_header   X-Cache-Lookup;

        expires 7d;
    }

    location / {
        return 404;
    }
}